# 🧪 测试指南

本文档说明如何运行和理解 Easy Bible 项目的单元测试。

## 📋 测试概览

项目包含以下测试：

### 1. **文章同步脚本单元测试** (`scripts/sync-articles.test.js`)
- 测试文章同步脚本的核心功能
- 包含 14 个测试用例
- 覆盖所有关键功能和边界情况

### 2. **环境测试脚本** (`scripts/test-sync.js`)
- 验证项目环境和文件结构
- 检查源文件和目标文件的状态

## 🚀 运行测试

### 运行所有单元测试

```bash
npm test
```

### 运行环境测试

```bash
npm run test:sync
```

### 直接运行测试文件

```bash
# 单元测试
node scripts/sync-articles.test.js

# 环境测试
node scripts/test-sync.js
```

## 📊 测试用例详解

### Test 1: parseMetaFile - 解析有效的 _meta.ts 文件
**目的**: 验证能正确解析标准格式的 `_meta.ts` 文件

**测试内容**:
- 创建包含 2 个条目的 `_meta.ts` 文件
- 解析文件并验证返回的条目数量和内容
- 确保 key 和 value 都被正确提取

**预期结果**: ✅ 解析出 2 个条目，内容完全匹配

---

### Test 2: parseMetaFile - 文件不存在时返回 null
**目的**: 验证处理文件不存在的情况

**测试内容**:
- 尝试解析一个不存在的文件路径
- 验证函数返回 `null`

**预期结果**: ✅ 返回 `null`，不抛出异常

---

### Test 3: parseMetaFile - 无效格式返回 null
**目的**: 验证处理格式错误的文件

**测试内容**:
- 创建一个内容无效的 `_meta.ts` 文件
- 尝试解析并验证返回值

**预期结果**: ✅ 返回 `null`，优雅处理错误

---

### Test 4: generateMetaFile - 生成正确格式的文件
**目的**: 验证生成的 `_meta.ts` 文件格式正确

**测试内容**:
- 生成包含 2 个条目的 `_meta.ts` 文件
- 检查文件内容是否包含：
  - `export default {`
  - 单引号包裹的 key 和 value
  - trailing comma
  - 正确的缩进
  - 末尾换行符

**预期结果**: ✅ 文件格式完全符合规范

---

### Test 5: generateMetaFile - 空条目不生成文件
**目的**: 验证空条目的处理

**测试内容**:
- 尝试用空数组生成 `_meta.ts` 文件
- 验证函数正确处理

**预期结果**: ✅ 函数直接返回，不创建文件

---

### Test 6: directoryExists - 正确检查目录是否存在
**目的**: 验证目录存在性检查功能

**测试内容**:
- 检查存在的目录 → 应返回 `true`
- 检查不存在的目录 → 应返回 `false`
- 检查文件路径（非目录） → 应返回 `false`

**预期结果**: ✅ 所有情况都正确判断

---

### Test 7: copyDirectory - 正确复制目录
**目的**: 验证目录复制功能

**测试内容**:
- 创建包含文件和子目录的源目录
- 复制到目标位置
- 验证所有文件和子目录都被正确复制
- 验证文件内容完整

**预期结果**: ✅ 目录结构和内容完全复制

---

### Test 8: 完整同步流程 - 同步单个文章
**目的**: 验证增量同步逻辑（只同步存在的文章）

**测试内容**:
- 创建包含 2 篇文章的 `_meta.ts`
- 只创建第 1 篇文章的实际目录
- 执行同步流程
- 验证只有存在的文章被同步
- 验证生成的 `_meta.ts` 只包含已同步的文章

**预期结果**: ✅ 只同步 1 篇文章，`_meta.ts` 只包含 1 个条目

---

### Test 9: 完整同步流程 - 同步多个文章
**目的**: 验证多篇文章的同步

**测试内容**:
- 创建包含 3 篇文章的卷
- 创建所有文章的实际目录
- 执行同步
- 验证所有文章都被正确同步

**预期结果**: ✅ 3 篇文章全部同步，`_meta.ts` 包含 3 个条目

---

### Test 10: Meta 文件格式保持 - 单引号和 trailing comma
**目的**: 验证格式规范的严格遵守

**测试内容**:
- 生成 `_meta.ts` 文件
- 检查文件内容是否使用：
  - 单引号（不是双引号）
  - trailing comma
  - 2 空格缩进

**预期结果**: ✅ 格式完全符合规范

---

### Test 11: 特殊字符处理 - Emoji 和中文
**目的**: 验证 Unicode 字符的正确处理

**测试内容**:
- 创建包含 Emoji 和中文的条目
- 生成并解析 `_meta.ts` 文件
- 验证特殊字符没有损坏

**预期结果**: ✅ Emoji 和中文完整保留

---

### Test 12: 边界情况 - 空卷（没有文章）
**目的**: 验证空卷的处理

**测试内容**:
- 创建 `_meta.ts` 但不创建任何文章目录
- 执行同步逻辑
- 验证没有文章被找到

**预期结果**: ✅ 正确识别为空卷

---

### Test 13: 覆盖已存在的目录
**目的**: 验证覆盖逻辑

**测试内容**:
- 创建目标目录并放入旧文件
- 复制新的源目录到同一位置
- 验证旧文件被删除，新文件被复制

**预期结果**: ✅ 旧内容被完全替换

---

### Test 14: 实际项目结构测试
**目的**: 验证实际项目文件的完整性

**测试内容**:
- 检查实际的 `articles/` 目录
- 解析根 `_meta.ts` 文件
- 遍历所有卷并统计文章数量
- 输出项目结构信息

**预期结果**: ✅ 成功解析所有卷和文章

**示例输出**:
```
ℹ️  找到 7 个卷
ℹ️  📖 Volume I： Creation and Fall: 5 篇文章
ℹ️  📖 Volume II： The Origin of Faith: 3 篇文章
ℹ️  📖 Volume III： Exodus and the Law: 4 篇文章
ℹ️  📖 Volume IV： Kingdom and War: 3 篇文章
ℹ️  📖 Volume V： Exile and Hope: 4 篇文章
ℹ️  📖 Volume VI： Redemption and Rebirth: 5 篇文章
ℹ️  📖 Volume VII： Legacy and Revelation: 3 篇文章
```

## 📈 测试覆盖范围

测试覆盖了以下功能模块：

- ✅ **Meta 文件解析** - 读取和解析 `_meta.ts` 文件
- ✅ **Meta 文件生成** - 创建格式正确的 `_meta.ts` 文件
- ✅ **目录操作** - 检查、复制、覆盖目录
- ✅ **增量同步逻辑** - 只同步存在的文章
- ✅ **格式规范** - 单引号、trailing comma、缩进
- ✅ **特殊字符** - Emoji、中文、Unicode
- ✅ **边界情况** - 空卷、不存在的文件、无效格式
- ✅ **实际项目验证** - 真实文件结构检查

## 🔧 添加新测试

如果需要添加新的测试用例，请遵循以下模式：

```javascript
/**
 * 测试 X: 测试名称
 */
function testX_testName() {
  console.log('Test X: 测试描述');
  
  // 1. 设置测试环境
  setupTestDir();
  
  // 2. 创建测试数据
  // ...
  
  // 3. 执行测试逻辑
  // ...
  
  // 4. 验证结果
  assert.strictEqual(actual, expected, '错误消息');
  
  console.log('  ✅ 通过\n');
  testsPassed++;
}
```

然后在 `runAllTests()` 函数中添加调用：

```javascript
function runAllTests() {
  try {
    // ... 现有测试
    testX_testName();  // 添加新测试
  } catch (error) {
    // ...
  }
}
```

## 🐛 测试失败处理

如果测试失败，会看到类似输出：

```
❌ 测试失败: Expected 2 but got 1
    at test4_generateMetaFile_correctFormat (scripts/sync-articles.test.js:123:10)
    ...
```

**调试步骤**：
1. 查看错误消息和堆栈跟踪
2. 检查失败的测试用例
3. 验证测试数据和预期结果
4. 修复代码或测试
5. 重新运行测试

## 📝 最佳实践

1. **每次修改代码后运行测试**
   ```bash
   npm test
   ```

2. **提交代码前确保所有测试通过**
   ```bash
   npm test && git commit
   ```

3. **添加新功能时编写对应测试**

4. **保持测试独立** - 每个测试应该能独立运行

5. **清理测试数据** - 测试完成后清理临时文件

## 🎯 持续集成

测试已集成到 GitHub Actions 工作流中。每次推送代码时，会自动运行测试。

查看 `.github/workflows/sync-articles.yml` 了解详情。

## 📞 获取帮助

如果遇到测试相关问题：
1. 查看测试输出的详细信息
2. 检查本文档的测试用例说明
3. 在 GitHub Issues 中报告问题

---

**最后更新**: 2025-11-06

